# Direct Calculation Method of Fluctuations

This code is the code that I have developed to calculate derivatives of correlation functions from LAMMPS and CP2K Molecular Dynamics simulations. So far - the code has support for msd, c2, shear viscosity, and the flux side correlation functions. Adding new correlation functions is relatively simple (just need to add them using fortran and call them in the submission script).

## How to Use the Program

Type the following in the Direct Calculation Fluctuations code.
```
bash backbone.sh
``` 

### Prerequisites
Currently: python 2.7 with scipy and numpy support, as well as the bash shell.
           Furthermore - this program assumes that you are running on a cluster environment with access to the Torque Q-engine

## Code Components

I will give a rundown of code components

### backbone.sh

This is the key backbone of the entire automation script. It functions by checking the completed tasks, and then performing the next task in the series of tasks. This means that you will primarily inteface with this software by rerunning the backbone.sh script repeatedly until it tells you to stop. 

The key backbone steps:  

1) Instructions Step (.flag_instruct)  
    -Tells you to create input_file and flucts.inp  
    -Lets you choose to create input_file through gen_input.py if you want.  
2) Compilation Step (.flag_compile)  
    -Compiles the fortran programs that matter (msd_rot_calc, visc_calc, flux_side)  
    -Creates the file mol_names (molecule names listed one after another on new lines)  
3) Trajectory Step (.flag_traj)  
    -Checks if the LONG trajectory has been run   
        -LAMMPS looks for log.lammps  
        -CP2K looks for cp2k.log  
    -CP2K ONLY: Creates RESTART directory, copies restart files into that directory and renames them.  
4) NVE Input Step (.flag_innve)  
    -Checks if you have created an input file for your nve simulation.  
        -LAMMPS looks for in.nve  
        -CP2K looks for in.nve.cp2k  
5) Run NVE Step (.flag_nve)  
    -USER: Asks whether you want to run NVE trajectories.  
    -Creates the file_names file (names of all file folders)  
    -Creates FILES directory  
    -Copies python scripts to top directory  
        -read_input.py  
        -set_msd_calcs.py  
        -gen_sub_scripts.py  
        -grab_press.py  
        -[non-]unif-sample.py  
    -Copies executables to top directory  
        -msd_rot_calc  
        -visc_calc  
        -flux_side  
    -Creates timestep file through [non-]unif-sample.py  
    -Runs NVE trajectories in FILES subsystem  
6) NVE Completion Step (.flag_nvecomplete)  
    -Checks for whether the last NVE run has completed.   
7) Checkup Step (.flag_checkup)  
    -LAMMPS: Checks to see if all subjobs have completed and reruns any missed jobs (if under 200)  
    -CP2K: Wishes you best of luck and hopes that all have completed.  
    -Moves all job array logs to a new directory logs.  
8) Grab Energies Step (.flag_grabflucts)  
    -Copies relevant grab_flucts.py to top directory  
    -Copies grabfluctsub.sh to top directory  
    -Submits grabfluctsub.sh  
9) Initialize Segments Step (.flag_initarray)  
    -Copies relevant python files to top directory  
        -init_flucts.py  
        -do_flucts.py  
    -Makes SEG directory  
    -Submits init_array.sh (generated by gen_sub_scripts.py in previous step)  
10) Fluctation Calculation Step (.flag_valcalc)  
    -Submits fluctuations calculation  
11) Cleanup  
    -Makes an Analysis Directory  
    -Moves all output files to this directory.  
    -Outputs a program complete message.  

### src:python:gen_input.py

This is a python code to generate input_file which is called in step 1).

It takes you line by line through each input_file command and generates the file.

### src:python:read_input.py

This is the python class file that reads and stores all the data in the input file. It is called by nearly every python program in the suite.

### src:python:gen_sub_scripts.py

This code generates almost all of the miscellanious job scripts/submit scripts. This has been keyed specifically to our cluster environment so it would likely need to be updated to match the particular environment.

Creates:    
    -run_array#.sh (job array file for nve runs)  
    -run_array (script that submits job arrays)  
    -nve.sh (nve file in case job fails)  
    -init_array.sh (file to submit init_flucts.py - for step 9)  
    -do_flucts (file to submit step 10)  

### src:python:grab_press.py

Python program that grabs pressure from the lammps log file for the shear viscosity calculation.

### src:python:checkup.py

Python program that checks whether all the runs have completed or not. 

### src:python:grab_flucts.py

Python program that takes the input of flucts.inp and grabs the energy components from that portion of the energy file.

LAMMPS: grabs directly from log.lammps  
CP2K: grabs from free-1.ener

Known Bugs: The energy file MUST be named free-1.ener. Future support incoming.

### src:python:init_flucts.py

Creates 500 trajectory block files of calculations of 1st, 2nd, 3rd, 4th derivatives.

Known Bugs: Only 1st derivative calcualtions are working currently.

### src:python:do_flucts.py

Pulls in the 500 trajectory block files and finishes the block averaging based on input_file.  
Reports uncertainties and produces a significant number of output files.  
Consider item1, item2 as two different energy components (ke and pe), mol as the molecule name, and corr as the correlation function. Then     
    -item1_mol_corr.dat is the regular correlation function, the 1st derivative, and the ratio of the two  
    -item1_item1_mol_corr.dat is the 2nd derivative correlation function  
    -item1_item2_mol_corr.dat is the cross derivative of the correlation function  
    -item1_item1_item1_mol_corr.dat is the 3rd derivative of the correlation function  
    -item1_item1_item1_item1_mol_corr.dat is the 4th derivative of the correlation function  
If considering particular blocks, the naming scheme works the same with the prefix [bl_#_]  

### src:python:set_msd_calcs.py

Creates input file for correlation functions.

### src:python:[non-]unif-sample.py

Creates time.dat used to plot the correlation functions.

### src:python:reor_fit.py and src:python:msd_fit.py

Fits the mean-squared displacements and the reorientation correlation functions.

### src:fortran:msd_rot_calc.f90

Calculates the mean squared displacement and the reorientation correlation function.

### src:fortran:flux_side.f90

Calculates the flux-side correlation functions.

### src:fortran:visc_calc.f90

Calculates the shear viscosity from the pressure tensor.


## Input File Generation

To generate input you need two files:

### flucts.inp

Two column file with energy component name in first column and number of the column in the log file.

i.e. 

e 3  
ke 4   
pe 6  
...  
etc  

### input_file

Easily generated by gen_input.py during step 1)

